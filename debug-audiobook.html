<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Audiobook Player</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #222; color: white; }
        .debug { background: #333; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .chapter-item { padding: 10px; margin: 5px 0; background: #444; cursor: pointer; border-radius: 3px; }
        .chapter-item:hover { background: #555; }
        #status { background: #000; padding: 10px; margin: 10px 0; font-family: monospace; }
    </style>
</head>
<body>
    <h1>Debug Audiobook Player</h1>
    
    <div id="status">Loading...</div>
    
    <div class="debug">
        <h3>Token Info:</h3>
        <div id="token-info"></div>
    </div>
    
    <div class="debug">
        <h3>DOM Elements:</h3>
        <div id="dom-info"></div>
    </div>
    
    <div class="debug">
        <h3>Chapter List:</h3>
        <div id="chapter-list"></div>
    </div>
    
    <div class="debug">
        <h3>Audio Test:</h3>
        <audio id="audio-player" controls style="width: 100%;"></audio>
        <button onclick="testAudio()">Test First Chapter</button>
    </div>

    <script>
        console.log('üö© Debug page started');
        
        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        
        // Chapter data
        const chapters = [
            { id: 1, title: "Opening Credits", file: "01_Opening+Credits.mp3" },
            { id: 2, title: "Dedication & Disclaimer", file: "02_DEDICATION+&+DISCLAIMER.mp3" },
            { id: 3, title: "Chapter 1 - The Red Flag Parade", file: "03_CHAPTER+1+-+THE+RED+FLAG+PARADE.mp3" }
            // Just testing with first 3 chapters
        ];
        
        function updateStatus(msg) {
            document.getElementById('status').textContent = msg;
            console.log('üìç', msg);
        }
        
        function testAudio() {
            const audio = document.getElementById('audio-player');
            const url = `/audio/${chapters[0].file}?token=${token}`;
            updateStatus(`Testing audio: ${url}`);
            audio.src = url;
            audio.load();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('DOM loaded, running diagnostics...');
            
            // Test token
            const tokenInfo = document.getElementById('token-info');
            if (token) {
                try {
                    const decoded = atob(token);
                    const [email, sessionId, timestamp] = decoded.split(':');
                    tokenInfo.innerHTML = `
                        <strong>Token found!</strong><br>
                        Email: ${email}<br>
                        Session: ${sessionId}<br>
                        Timestamp: ${timestamp}<br>
                        Date: ${new Date(parseInt(timestamp))}
                    `;
                } catch (e) {
                    tokenInfo.innerHTML = `<strong>Token decode error:</strong> ${e.message}`;
                }
            } else {
                tokenInfo.innerHTML = '<strong>No token found in URL!</strong>';
            }
            
            // Test DOM elements
            const domInfo = document.getElementById('dom-info');
            const elements = ['audio-player', 'chapter-list'];
            let domStatus = '';
            elements.forEach(id => {
                const el = document.getElementById(id);
                domStatus += `${id}: ${el ? '‚úÖ Found' : '‚ùå Missing'}<br>`;
            });
            domInfo.innerHTML = domStatus;
            
            // Test chapter list
            const chapterList = document.getElementById('chapter-list');
            let chapterHTML = `Found ${chapters.length} chapters:<br>`;
            chapters.forEach((chapter, index) => {
                chapterHTML += `
                    <div class="chapter-item" onclick="playChapter(${index})">
                        ${chapter.id}. ${chapter.title} (${chapter.file})
                    </div>
                `;
            });
            chapterList.innerHTML = chapterHTML;
            
            updateStatus('All diagnostics complete');
        });
        
        function playChapter(index) {
            const chapter = chapters[index];
            const audio = document.getElementById('audio-player');
            const url = `/audio/${chapter.file}?token=${token}`;
            updateStatus(`Loading: ${chapter.title}`);
            audio.src = url;
            audio.load();
            audio.play().catch(e => {
                updateStatus(`Play error: ${e.message}`);
            });
        }
    </script>
</body>
</html>
