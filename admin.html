<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Aleks Filmore</title>
    <meta name="description" content="Comprehensive admin dashboard for sales analytics, order management, email delivery, and business intelligence.">
    <link rel="stylesheet" href="css/tailwind.min.css"><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-dark-bg: #0f172a;
            --color-card-bg: #1e293b;
            --color-accent: #3b82f6;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
        }
        
        body {
            background: linear-gradient(135deg, var(--color-dark-bg) 0%, #1e293b 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .card {
            background: var(--color-card-bg);
            border: 1px solid #334155;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -3px rgba(0, 0, 0, 0.2);
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--color-card-bg) 0%, #2d3748 100%);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .loading-spinner {
            border: 2px solid #334155;
            border-top: 2px solid var(--color-accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--color-accent) 0%, #2563eb 100%);
            border: none;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            transform: translateY(-1px);
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.75);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .table-row:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        
        .status-pending {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.2);
        }
        
        .status-failed {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
    </style>
    <script>
    
    <!-- Login Modal (inserted to prevent blank page when unauthenticated) -->
    <div id="login-modal" class="modal-overlay">
        <div class="modal-content bg-slate-800 border border-slate-700 rounded-2xl p-6 max-w-md w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Admin Login</h2>
            </div>
            <form class="space-y-4" onsubmit="return false;">
                <div>
                    <label for="password" class="text-sm text-slate-400">Password</label>
                    <input id="password" type="password" class="w-full mt-2 p-3 rounded bg-slate-900 border border-slate-700 text-white" placeholder="Enter admin password" required />
                </div>
                <div id="login-error" class="hidden text-sm text-red-400"></div>
                <div class="flex justify-end">
                    <button id="login-submit-btn" type="submit" class="btn-primary px-4 py-2 rounded">Enter Dashboard</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Analytics Modal -->

        // State
        let allOrders = [];
        let currentResendOrderId = null;
        const charts = {};

        class AuthManager {
            constructor() {
                this.token = localStorage.getItem('admin_token');
                this.sessionExpiry = Number(localStorage.getItem('admin_session_expiry')) || 0;
            }

            async login(password) {
                try {
                    const res = await fetch('/.netlify/functions/admin-login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password })
                    });

                    if (!res.ok) return false;
                    const data = await res.json();
                    if (!data.token) return false;

                    this.token = data.token;
                    const expiry = data.expiry || (Date.now() + 1000 * 60 * 60);
                    this.sessionExpiry = Number(expiry);
                    localStorage.setItem('admin_token', this.token);
                    localStorage.setItem('admin_session_expiry', String(this.sessionExpiry));
                    return true;
                } catch (e) {
                    console.error('Login error', e);
                    return false;
                }
            }

            logout() {
                this.token = null;
                this.sessionExpiry = 0;
                localStorage.removeItem('admin_token');
                localStorage.removeItem('admin_session_expiry');
                location.reload();
            }

            isValid() {
                return !!this.token && this.sessionExpiry && Date.now() < this.sessionExpiry;
            }
        }

        const authManager = new AuthManager();

        async function authenticatedFetch(path, opts = {}) {
            const headers = Object.assign({}, opts.headers || {});
            if (authManager.token) headers['Authorization'] = `Bearer ${authManager.token}`;
            if (!headers['Content-Type']) headers['Content-Type'] = 'application/json';
            return fetch(path, Object.assign({}, opts, { headers }));
        }

        function showToast(msg, type = 'info') {
            const toast = document.getElementById('toast');
            if (!toast) return;
            const color = type === 'success' ? 'bg-green-600' : type === 'error' ? 'bg-red-600' : type === 'warning' ? 'bg-yellow-600' : 'bg-blue-600';
            toast.className = `toast ${color} text-white px-6 py-3 rounded-lg shadow-lg`;
            toast.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3500);
        }

        function showSpinner(message) { showToast(message || 'Loading...', 'info'); }
        function hideSpinner() { }

        async function handleLogin(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            const btn = document.getElementById('login-submit-btn');
            const err = document.getElementById('login-error');
            btn.disabled = true; btn.textContent = 'Authenticating...';
            err.classList.add('hidden');
            const ok = await authManager.login(password);
            if (ok) {
                document.getElementById('login-modal').classList.remove('show');
                initializeDashboard();
            } else {
                err.textContent = 'Invalid password or server error';
                err.classList.remove('hidden');
            }
            btn.disabled = false; btn.textContent = 'Enter Dashboard';
            document.getElementById('password').value = '';
            return false;
        }

        function initializeDashboard() {
            const main = document.querySelector('main'); if (main) main.style.display = 'block';
            loadDashboardData(); initializeCharts(); checkSystemStatus();
        }

        async function loadDashboardData() {
            try { await Promise.all([loadOrdersData(), loadAnalyticsData(), loadMailerLiteData()]); showToast('Dashboard loaded', 'success'); }
            catch (e) { console.error('Dashboard load error', e); showToast('Error loading dashboard data', 'error'); }
        }

        async function loadOrdersData() {
            try {
                const res = await authenticatedFetch('/.netlify/functions/admin-orders');
                if (!res.ok) throw new Error('Orders API error ' + res.status);
                const orders = await res.json(); allOrders = orders || [];
                renderOrdersTable(allOrders); updateChartsFromOrders(allOrders);
            } catch (e) { console.error('loadOrdersData', e); showToast('Failed to load orders', 'error'); }
        }

        function renderOrdersTable(orders) {
            const tbody = document.getElementById('orders-tbody'); if (!tbody) return;
            if (!orders || !orders.length) { tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-6 text-center text-slate-400">No orders yet.</td></tr>`; return; }
            tbody.innerHTML = orders.map(order => {
                const amount = typeof order.amount === 'number' ? `$${order.amount.toFixed(2)}` : order.amount;
                const products = (order.products || []).map(p => p.title || p.id).join(', ');
                const hasAudiobook = !!order.hasAudiobook || (order.products || []).some(p => p.id === 'audiobook');
                const resendBtn = hasAudiobook ? `<button class="px-2 py-1 text-sm bg-blue-600 rounded text-white" onclick="resendAudiobook('${order.id}')">Resend</button>` : '';
                const shipBtn = (order.products || []).some(p => p.id === 'signed-book') ? `<button class="px-2 py-1 text-sm bg-amber-600 rounded text-white" onclick="updateOrderStatus('${order.id}','shipped')">Mark Shipped</button>` : '';
                const deliverBtn = `<button class="px-2 py-1 text-sm bg-green-600 rounded text-white" onclick="updateOrderStatus('${order.id}','delivered')">Mark Delivered</button>`;
                return `
                    <tr class="table-row text-sm border-b border-slate-700">
                        <td class="px-3 py-3">${order.id}</td>
                        <td class="px-3 py-3">${order.email || order.customer || '—'}</td>
                        <td class="px-3 py-3">${products}</td>
                        <td class="px-3 py-3">${amount}</td>
                        <td class="px-3 py-3">${order.status || 'new'}</td>
                        <td class="px-3 py-3"><div class="flex gap-2">${resendBtn}${shipBtn}${deliverBtn}<button class="px-2 py-1 text-sm bg-slate-600 rounded text-white" onclick="viewOrder('${order.id}')">View</button></div></td>
                    </tr>`;
            }).join('');
        }

        // Open a full order detail modal (replaces the simple JSON alert)
        window.viewOrder = function (orderId) { openOrderModal(orderId); };

        // Modal helpers
        function openOrderModal(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return showToast('Order not found', 'error');
            // Populate fields
            document.getElementById('order-modal-id').textContent = order.id || '';
            document.getElementById('order-modal-email').textContent = order.email || order.customer || '';
            document.getElementById('order-modal-products').textContent = (order.products||[]).map(p => p.title||p.id).join('\n');
            document.getElementById('order-modal-amount').textContent = typeof order.amount === 'number' ? `$${order.amount.toFixed(2)}` : (order.amount||'');
            document.getElementById('order-status-select').value = order.status || 'new';
            document.getElementById('order-shipping-address').value = (order.shipping && order.shipping.address) ? JSON.stringify(order.shipping.address, null, 2) : (order.shippingAddress || order.address || '');
            document.getElementById('order-personalization-note').value = order.personalizationNote || order.note || '';
            document.getElementById('order-modal').classList.add('show');
            // attach save handler data
            document.getElementById('order-modal').dataset.orderId = orderId;
        }

        function closeOrderModal() {
            const modal = document.getElementById('order-modal');
            if (modal) modal.classList.remove('show');
        }

        async function saveOrderChanges(sendConfirmation = false) {
            const modal = document.getElementById('order-modal');
            if (!modal) return;
            const orderId = modal.dataset.orderId;
            const status = document.getElementById('order-status-select').value;
            let shippingRaw = document.getElementById('order-shipping-address').value || '';
            let shipping = null;
            try { shipping = JSON.parse(shippingRaw); } catch (e) { shipping = { raw: shippingRaw }; }
            const personalization = document.getElementById('order-personalization-note').value || '';
            try {
                const payload = { orderId, status, shipping, personalization, sendConfirmation };
                const res = await authenticatedFetch('/.netlify/functions/admin-update-order', { method: 'POST', body: JSON.stringify(payload) });
                if (!res.ok) throw new Error('Update failed');
                // update local cache
                allOrders = allOrders.map(o => o.id === orderId ? Object.assign({}, o, { status, shipping, personalizationNote: personalization }) : o);
                renderOrdersTable(allOrders);
                showToast('Order saved', 'success');
                closeOrderModal();
                // Optionally trigger a dedicated confirmation email endpoint first, fallback to resend-audiobook
                if (sendConfirmation) {
                    try {
                        const rSpecial = await authenticatedFetch('/.netlify/functions/send-order-confirmation', { method: 'POST', body: JSON.stringify({ orderId }) });
                        if (rSpecial.ok) {
                            showToast('Confirmation email sent', 'success');
                        } else {
                            // fallback
                            const r2 = await authenticatedFetch('/.netlify/functions/resend-audiobook', { method: 'POST', body: JSON.stringify({ orderId }) });
                            if (r2.ok) showToast('Confirmation email sent (fallback)', 'success');
                            else showToast('Failed to send confirmation', 'warning');
                        }
                    } catch (e) { console.error('send confirmation', e); showToast('Failed to send confirmation', 'warning'); }
                }
            } catch (e) { console.error('saveOrderChanges', e); showToast('Failed to save order', 'error'); }
        }

        // Sales range - prefer cached aggregates, fall back to live aggregator
        async function applySalesRange() {
            const select = document.getElementById('sales-range');
            const v = (select && select.value) || 'last7';
            const el = document.getElementById('sales-range-total');
            try {
                showSpinner('Loading sales summary...');

                // Prefer the cached endpoint for speed
                let res = await authenticatedFetch('/.netlify/functions/aggregates-cache?range=' + encodeURIComponent(v));
                if (res.status === 404) {
                    // cache not found -> fall back to live
                    res = await authenticatedFetch('/.netlify/functions/admin-sales-aggregate?range=' + encodeURIComponent(v));
                }

                if (!res.ok) {
                    // Try live aggregator as a final fallback
                    try {
                        const fallback = await authenticatedFetch('/.netlify/functions/admin-sales-aggregate?range=' + encodeURIComponent(v));
                        if (fallback.ok) res = fallback;
                    } catch (e) { /* ignore */ }
                }

                if (!res.ok) {
                    throw new Error('Aggregate API error ' + res.status);
                }

                const data = await res.json();
                const total = Number(data.total || 0);
                if (el) el.textContent = `$${total.toFixed(2)}`;
                // If cached endpoint provided daily buckets (days), update charts accordingly
                if (charts.revenue) {
                    try {
                        if (data.days && Array.isArray(data.days)) {
                            const labels = data.days.slice(-7).map(d => d.date.slice(5));
                            const values = data.days.slice(-7).map(d => d.total);
                            charts.revenue.data.labels = labels;
                            charts.revenue.data.datasets[0].data = values;
                        } else {
                            charts.revenue.data.labels = [v];
                            charts.revenue.data.datasets[0].data = [total];
                        }
                        charts.revenue.update();
                    } catch (e) { /* non-fatal */ }
                }
            } catch (e) {
                console.error('applySalesRange', e);
                showToast('Failed to load sales summary', 'error');
            } finally {
                hideSpinner();
            }
        }

        // Session timer UX
        function startSessionTimer() {
            const el = document.getElementById('session-remaining');
            if (!el) return;
            function tick() {
                const expiry = Number(localStorage.getItem('admin_session_expiry')) || 0;
                const ms = expiry - Date.now();
                if (ms <= 0) { el.textContent = 'Session expired'; authManager.logout(); return; }
                const s = Math.floor(ms/1000); const m = Math.floor(s/60); const secs = s%60;
                el.textContent = `${m}m ${secs}s`;
            }
            tick(); setInterval(tick, 1000);
        }

        window.resendAudiobook = async function (orderId) {
            if (!confirm('Resend audiobook download email to customer?')) return;
            try {
                const res = await authenticatedFetch('/.netlify/functions/resend-audiobook', { method: 'POST', body: JSON.stringify({ orderId }) });
                if (res.ok) showToast('Audiobook email resent', 'success');
                else { const err = await res.text(); console.error('resendAudiobook error', err); showToast('Failed to resend audiobook email', 'error'); }
            } catch (e) { console.error(e); showToast('Error resending email', 'error'); }
        };

        window.updateOrderStatus = async function (orderId, status) {
            try {
                const res = await authenticatedFetch('/.netlify/functions/admin-update-order', { method: 'POST', body: JSON.stringify({ orderId, status }) });
                if (!res.ok) throw new Error('Update failed');
                allOrders = allOrders.map(o => o.id === orderId ? Object.assign({}, o, { status: status }) : o);
                renderOrdersTable(allOrders); showToast('Order status updated', 'success');
            } catch (e) { console.error('updateOrderStatus', e); showToast('Failed to update order', 'error'); }
        };

        function initializeCharts() { try { const revenueCtx = document.getElementById('revenue-chart'); if (revenueCtx) charts.revenue = new Chart(revenueCtx, { type: 'line', data: { labels: [], datasets: [{ label: 'Revenue', data: [], backgroundColor: 'rgba(59,130,246,0.2)', borderColor: '#3b82f6' }] }, options: { responsive: true } }); const productCtx = document.getElementById('product-chart'); if (productCtx) charts.product = new Chart(productCtx, { type: 'doughnut', data: { labels: ['Audiobooks', 'Signed Books', 'Bundles'], datasets: [{ data: [0,0,0], backgroundColor: ['#60a5fa','#a78bfa','#f472b6'] }] }, options: { responsive: true } }); } catch (e) { console.warn('Charts not available', e); } }

        function updateChartsFromOrders(orders) {
            if (!orders) return;
            if (charts.revenue) {
                const days = Array.from({ length: 7 }).map((_,i) => { const d = new Date(); d.setDate(d.getDate() - (6 - i)); return `${d.getMonth()+1}/${d.getDate()}`; });
                const amounts = days.map((_, idx) => { const date = new Date(); date.setDate(date.getDate() - (6 - idx)); const dayStr = date.toISOString().split('T')[0]; return orders.filter(o => (o.date || '').startsWith(dayStr)).reduce((s,o)=> s + (Number(o.amount)||0), 0); });
                charts.revenue.data.labels = days; charts.revenue.data.datasets[0].data = amounts; charts.revenue.update();
            }
            if (charts.product) {
                const map = { audiobook: 0, 'signed-book': 0, bundle: 0 };
                orders.forEach(o => (o.products||[]).forEach(p => { if (p.id in map) map[p.id] += 1; }));
                charts.product.data.datasets[0].data = [map.audiobook, map['signed-book'], map.bundle]; charts.product.update();
            }
        }

        async function loadAnalyticsData() {
            try {
                const res = await authenticatedFetch('/.netlify/functions/audiobook-analytics');
                if (res.ok) { const data = await res.json(); if (data.minutesListened !== undefined) updateText('audiobook-minutes', data.minutesListened.toLocaleString()); if (data.listeners !== undefined) updateText('audiobook-listeners', data.listeners.toLocaleString()); window.__audiobookAnalytics = data; }
                const ga = await authenticatedFetch('/.netlify/functions/google-analytics-data'); if (ga.ok) { const gdata = await ga.json(); if (gdata.pageViews) updateText('ga-page-views', String(gdata.pageViews.value || gdata.pageViews)); }
            } catch (e) { console.error('loadAnalyticsData', e); }
        }

        async function loadMailerLiteData() {
            try {
                const res = await authenticatedFetch('/.netlify/functions/mailerlite-data');
                if (!res.ok) throw new Error('MailerLite error');
                const data = await res.json();
                if (data.totalSubscribers !== undefined) updateText('ml-total-subscribers', String(data.totalSubscribers.value || data.totalSubscribers));
                window.__mlCampaigns = data.recentActivity || [];
                renderMailerLiteCampaigns();
            } catch (e) { console.error('loadMailerLiteData', e); }
        }
        
        // Render MailerLite campaigns into the newsletter modal and wire send actions
        function renderMailerLiteCampaigns() {
            const container = document.getElementById('ml-campaigns-list');
            if (!container) return;
            const campaigns = window.__mlCampaigns || [];
            if (!campaigns.length) { container.innerHTML = '<p class="text-slate-400">No recent campaigns found.</p>'; return; }
            container.innerHTML = campaigns.map(c => {
                const id = c.id || c.campaign_id || c.campaignId || (c.name && c.name.replace(/\s+/g,'-').toLowerCase());
                const title = c.title || c.name || ('Campaign ' + (id||'--'));
                const sent = (c.sent || c.delivered || c.recipients || 0);
                const date = c.date || c.created_at || '';
                return `
                    <div class="p-3 bg-slate-900 rounded mb-3" data-campaign-id="${id}">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-sm text-slate-300 font-medium">${title}</div>
                                <div class="text-xs text-slate-500">Sent: ${sent} — ${date}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <button class="ml-send btn-primary px-3 py-1 rounded text-sm text-white" data-campaign-id="${id}">Send Bonus</button>
                            </div>
                        </div>
                        <div class="mt-2 hidden progress-wrap"><div class="h-2 bg-slate-800 rounded overflow-hidden"><div class="progress-bar bg-green-500 h-full" style="width:0%"></div></div><div class="text-xs text-slate-400 mt-1 progress-label">Queued</div></div>
                    </div>`;
            }).join('');

            // Attach send handlers
            container.querySelectorAll('.ml-send').forEach(btn => {
                btn.addEventListener('click', async (ev) => {
                    const campaignId = btn.dataset.campaignId;
                    await sendBonusToCampaign(campaignId, btn);
                });
            });
        }

        async function sendBonusToCampaign(campaignId, btnEl) {
            if (!campaignId) return showToast('Missing campaign id', 'error');
            btnEl.disabled = true; btnEl.textContent = 'Starting...';
            const wrapper = btnEl.closest('[data-campaign-id]');
            const progressWrap = wrapper && wrapper.querySelector('.progress-wrap');
            const progressBar = wrapper && wrapper.querySelector('.progress-bar');
            const progressLabel = wrapper && wrapper.querySelector('.progress-label');
            if (progressWrap) progressWrap.classList.remove('hidden');
            try {
                const res = await authenticatedFetch('/.netlify/functions/send-bonus-chapter', { method: 'POST', body: JSON.stringify({ campaignId }) });
                if (!res.ok) {
                    const text = await res.text();
                    console.error('sendBonusToCampaign failed', text);
                    showToast('Failed to start send', 'error');
                    btnEl.disabled = false; btnEl.textContent = 'Send Bonus';
                    if (progressLabel) progressLabel.textContent = 'Failed to queue';
                    return;
                }
                // If the function returns a job id or progress endpoint, poll for updates
                const data = await res.json().catch(() => ({}));
                const jobId = data.jobId || data.id || null;
                if (progressLabel) progressLabel.textContent = 'Queued';
                // If there's a job id and a progress endpoint, poll; otherwise simulate progress
                if (jobId && data.progressEndpoint) {
                    let pct = 0;
                    while (pct < 100) {
                        const p = await fetch(data.progressEndpoint + '?job=' + encodeURIComponent(jobId));
                        const pj = await p.json().catch(() => ({}));
                        pct = Math.min(100, Number(pj.percent || pj.progress || pct+10));
                        if (progressBar) progressBar.style.width = pct + '%';
                        if (progressLabel) progressLabel.textContent = (pct < 100) ? `Sending (${pct}%)` : 'Completed';
                        if (pct >= 100) break;
                        await new Promise(r => setTimeout(r, 1000));
                    }
                } else {
                    // Simulated progress UI for servers that don't provide jobId
                    for (let i=10;i<=100;i+=10) { if (progressBar) progressBar.style.width = i + '%'; if (progressLabel) progressLabel.textContent = `Sending (${i}%)`; await new Promise(r => setTimeout(r, 300)); }
                    if (progressLabel) progressLabel.textContent = 'Completed';
                }
                showToast('Bonus chapter send started', 'success');
                btnEl.textContent = 'Sent';
            } catch (e) {
                console.error('sendBonusToCampaign error', e); showToast('Error sending bonus', 'error'); btnEl.disabled = false; btnEl.textContent = 'Send Bonus';
                if (progressLabel) progressLabel.textContent = 'Error';
            }
        }

        async function checkSystemStatus() { try { if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') return updateSystemStatus('mock'); const res = await authenticatedFetch('/.netlify/functions/admin-test-env-vars'); if (res.ok) updateSystemStatus('operational'); else updateSystemStatus('degraded'); } catch (e) { console.error('checkSystemStatus', e); updateSystemStatus('degraded'); } }

        function updateSystemStatus(type) { updateText('stripe-status', type === 'mock' || type === 'operational' ? '✅ Connected' : '⚠️ Issue'); updateText('analytics-status', type === 'operational' ? '✅ Connected' : '⚠️ Issue'); updateText('email-status', type === 'operational' ? '✅ Connected' : '⚠️ Issue'); updateText('newsletter-status', type === 'operational' ? '✅ Connected' : '⚠️ Issue'); }

        function updateText(id, text) { const el = document.getElementById(id); if (el) el.textContent = text; }

        function exportOrders() { if (!allOrders || !allOrders.length) return showToast('No orders to export', 'warning'); const headers = ['Order ID','Email','Products','Amount','Status','Date']; const rows = allOrders.map(o => [o.id, o.email || '', (o.products||[]).map(p=>p.title||p.id).join('|'), o.amount||'', o.status||'', o.date||'']); const csv = [headers.join(','), ...rows.map(r => r.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(','))].join('\n'); const blob = new Blob([csv], { type: 'text/csv' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `orders-${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(url); showToast('Export started','success'); }

        document.addEventListener('DOMContentLoaded', () => {
            if (authManager.isValid()) initializeDashboard(); else document.getElementById('login-modal').classList.add('show');
            const filter = document.getElementById('order-filter'); if (filter) filter.addEventListener('change', () => { const v = filter.value; const filtered = (v === 'all') ? allOrders : allOrders.filter(o => o.status === v); renderOrdersTable(filtered); });
            const exportBtn = document.querySelector('[onclick="exportOrders()"]'); if (exportBtn) exportBtn.addEventListener('click', exportOrders);
            const loginForm = document.querySelector('#login-modal form'); if (loginForm) loginForm.addEventListener('submit', handleLogin);
            const salesApply = document.getElementById('refresh-range'); if (salesApply) salesApply.addEventListener('click', applySalesRange);
            startSessionTimer();
        });

        window.refreshData = async function () { await loadDashboardData(); checkSystemStatus(); showToast('Refreshed', 'success'); };
        window.logout = function () { authManager.logout(); };
    </script>
    

    <!-- Analytics Modal -->
    <div id="analytics-modal" class="modal-overlay">
        <div class="modal-content bg-slate-800 border border-purple-500/20 rounded-2xl p-6 max-w-4xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-400">📊 Google Analytics Dashboard</h2>
                <button onclick="closeAnalyticsDashboard()" class="text-red-400 hover:text-red-300 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Page Views</p>
                    <p id="analytics-pageviews" class="text-xl font-bold">--</p>
                </div>
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Sessions</p>
                    <p id="analytics-sessions" class="text-xl font-bold">--</p>
                </div>
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Bounce Rate</p>
                    <p id="analytics-bounce-rate" class="text-xl font-bold">--</p>
                </div>
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Avg. Duration</p>
                    <p id="analytics-avg-duration" class="text-xl font-bold">--</p>
                </div>

        <!-- Sales Range Controls -->
        <div class="card p-4 rounded-lg mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <label class="text-sm text-slate-400">Sales range:</label>
                    <select id="sales-range" class="bg-slate-700 border border-slate-600 rounded px-3 py-2 text-sm">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="last7" selected>Last 7 days</option>
                        <option value="thisMonth">This month</option>
                        <option value="lastMonth">Last month</option>
                        <option value="last3months">Last 3 months</option>
                    </select>
                    <button id="refresh-range" class="btn-primary px-3 py-2 rounded text-sm">Apply</button>
                </div>
                <div class="text-sm text-slate-400">Total: <span id="sales-range-total">—</span></div>
            </div>
        </div>
            </div>
            <div id="analytics-content" class="space-y-6">
                <div class="text-center py-8">
                    <div class="animate-spin w-8 h-8 border-2 border-purple-400 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-gray-400">Loading Analytics Data...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Newsletter Modal -->
    <div id="newsletter-modal" class="modal-overlay">
        <div class="modal-content bg-slate-800 border border-green-500/20 rounded-2xl p-6 max-w-4xl w-full mx-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-green-400">📧 Newsletter Manager</h2>
                <button onclick="closeNewsletterManager()" class="text-red-400 hover:text-red-300 text-2xl">&times;</button>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Total Subscribers</p>
                    <p id="newsletter-total-subscribers" class="text-xl font-bold">--</p>
                </div>
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Active Subscribers</p>
                    <p id="newsletter-active-subscribers" class="text-xl font-bold">--</p>
                </div>
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Unsubscribed</p>
                    <p id="newsletter-unsubscribed" class="text-xl font-bold">--</p>
                </div>
                <div class="stat-card p-4 rounded">
                    <p class="text-xs text-slate-400">Growth Rate</p>
                    <p id="newsletter-growth-rate" class="text-xl font-bold">--</p>
                </div>
            </div>
            <div id="newsletter-content" class="space-y-6">
                <div class="text-center py-8">
                    <div class="animate-spin w-8 h-8 border-2 border-green-400 border-t-transparent rounded-full mx-auto mb-4"></div>
                    <p class="text-gray-400">Loading Newsletter Data...</p>
                </div>
                <div id="ml-campaigns-list" class="mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Order Detail Modal -->
    <div id="order-modal" class="modal-overlay" data-order-id="">
        <div class="modal-content bg-slate-800 border border-slate-700 rounded-2xl p-6 max-w-3xl w-full mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold">Order Details — <span id="order-modal-id">#</span></h3>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-slate-400">Session: <span id="session-remaining">--</span></span>
                    <button onclick="closeOrderModal()" class="text-red-400 hover:text-red-300 text-2xl">&times;</button>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <p class="text-xs text-slate-400">Customer</p>
                    <p id="order-modal-email" class="font-medium">-</p>
                    <p class="text-xs text-slate-400 mt-2">Products</p>
                    <pre id="order-modal-products" class="text-sm bg-slate-900 p-2 rounded text-slate-200"></pre>
                    <p class="text-xs text-slate-400 mt-2">Amount</p>
                    <p id="order-modal-amount" class="font-medium">-</p>
                </div>
                <div>
                    <label class="text-xs text-slate-400">Status</label>
                    <select id="order-status-select" class="w-full bg-slate-700 border border-slate-600 rounded px-2 py-2">
                        <option value="new">New</option>
                        <option value="processing">Processing</option>
                        <option value="shipped">Shipped</option>
                        <option value="delivered">Delivered</option>
                        <option value="refunded">Refunded</option>
                    </select>
                    <label class="text-xs text-slate-400 mt-3 block">Shipping Address (JSON or plain)</label>
                    <textarea id="order-shipping-address" class="w-full h-24 bg-slate-900 p-2 rounded text-sm text-slate-200"></textarea>
                    <label class="text-xs text-slate-400 mt-3 block">Personalization / Note</label>
                    <textarea id="order-personalization-note" class="w-full h-24 bg-slate-900 p-2 rounded text-sm text-slate-200"></textarea>
                </div>
            </div>
            <div class="flex justify-end gap-3 mt-4">
                <button onclick="saveOrderChanges(false)" class="px-4 py-2 bg-slate-600 rounded text-white">Save</button>
                <button onclick="saveOrderChanges(true)" class="px-4 py-2 bg-green-600 rounded text-white">Save & Send Confirmation</button>
            </div>
        </div>
    </div>

    <script>console.log('🎯 Advanced Admin Dashboard JavaScript loaded successfully');</script>
</body>
</html>

