<!DOCTYPE html>
<h            'bundle': {
                name: 'Complete Bundle (Audiobook + Signed Paperback)', 
                price: 24.99,
                type: 'bundle',lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Enhanced SEO Meta Tags -->
    <title>Secure Checkout | Aleks Film                        </div>
                    </div>

                    <!-- Discount Code Section -->
                    <div id="discount-section" class="mb-8" style="display: none;">
               'signed-book': {
                name: 'The Worst Boyfriends Ever (Signed Paperback)',
                price: 19.99,
                type: 'physical',
                stripeUrl: 'https://buy.stripe.com/28E3codAw4gG0LW6Vv9fW01',
                description: 'Personally signed paperback with handwritten note'
            },
            'bundle': {
                name: 'Complete Bundle (Audiobook + Signed Paperback)',
                price: 22.99,
                type: 'bundle',
                stripeUrl: 'https://buy.stripe.com/9B66oA0NKdRgamw4Nn9fW02',
                description: 'Both audiobook and signed paperback together'
            }   <h3 class="font-display font-semibold text-xl mb-4"><svg class="premium-icon colored-lime" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/>
        <path d="M12 18V6"/>
    </svg> Discount Code</h3>
                        <div class="discount-code-container p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-green-400"><svg class="premium-icon colored-lime" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 2v4l-3 2v4h18V8l-3-2V2"/>
        <path d="M16 4V2"/>
        <path d="M12 4V2"/>
        <path d="M8 4V2"/>
        <path d="M8 22l8-10H8l8-10"/>
    </svg> 20% OFF Applied!</span>
                                <span id="discount-amount" class="font-bold text-green-400">-$1.60</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span>Code: <code id="applied-discount-code" class="bg-charcoal/50 px-2 py-1 rounded"></code></span>
                                <button onclick="removeDiscount()" class="text-red-500 hover:text-red-400 text-xs">Remove</button>
                            </div>
                            <div class="text-xs text-bone/60 mt-2">
                                Discount will be refunded after payment processing
                            </div>
                        </div>
                    </div>

                    <!-- Newsletter Signup -->
                    <div class="mb-8 p-4 bg-glitch-lime/10 border border-glitch-lime/30 rounded-lg">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="newsletter-signup" class="form-checkbox text-red-flag">
                            <div>
                                <div class="font-medium">🚩 Join the Red Flag Report (Optional)</div>
                                <div class="text-sm text-bone/70">Get updates on new books, exclusive content, and dating disaster stories. Unsubscribe anytime.</div>
                            </div>
                        </label>
                    }e Your Purchase</title>
    <meta name="description" content="Complete your purchase securely with Stripe. Add custom notes and dedication requests for signed copies of The Worst Boyfriends Ever.">
    <meta name="keywords" content="checkout, secure payment, Stripe payment, custom dedication, signed book purchase, Aleks Filmore">
    <meta name="author" content="Aleks Filmore">
    <meta name="robots" content="noindex, nofollow">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://aleksfilmore.com/checkout.html">
    
    <!-- Google Analytics dynamic loader (no hardcoded ID) -->
    <script>window.GA_MEASUREMENT_ID = window.GA_MEASUREMENT_ID || undefined;</script>
    <script src="/js/ga-loader.js" defer></script>
    
    <!-- Tailwind CSS -->
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/css/tailwind.min.css">
    
    <!-- Cookie Notice CSS -->
    <link rel="stylesheet" href="css/cookie-notice.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --color-charcoal: #0E0F10;
            --color-bone: #F7F3ED;
            --color-red-flag: #FF3B3B;
            --color-glitch-lime: #C7FF41;
            --color-dusty-blush: #F1B7C4;
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--color-charcoal) 0%, #1a1a1a 100%);
            font-family: var(--font-body);
            color: var(--color-bone);
            line-height: 1.6;
        }

        .font-display { font-family: var(--font-display); }

        .checkout-card {
            background: linear-gradient(135deg, rgba(247, 243, 237, 0.08) 0%, rgba(247, 243, 237, 0.04) 100%);
            border: 1px solid rgba(247, 243, 237, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .form-input {
            background: rgba(247, 243, 237, 0.1);
            border: 1px solid rgba(247, 243, 237, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--color-bone);
            width: 100%;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: var(--color-red-flag);
            outline: none;
        }

        .form-input::placeholder {
            color: rgba(247, 243, 237, 0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-red-flag) 0%, #e63946 100%);
            color: var(--color-bone);
            font-family: var(--font-display);
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            box-shadow: 0 4px 16px rgba(255, 59, 59, 0.25);
            width: 100%;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 59, 59, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-bone);
            font-family: var(--font-display);
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--color-bone);
        }
        
        .btn-secondary:hover {
            background: var(--color-bone);
            color: var(--color-charcoal);
            transform: translateY(-1px);
        }

        .price-tag {
            background: linear-gradient(135deg, var(--color-red-flag) 0%, #e63946 100%);
            color: var(--color-bone);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(255, 59, 59, 0.3);
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-bone);
            border-top: 2px solid var(--color-red-flag);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Optimization Scripts -->
    <script src="/js/image-optimizer.js" defer></script>
    <script src="/js/social-proof.js" defer></script>
    <script src="/js/exit-intent.js" defer></script>
    <script src="/js/trust-badges.js" defer></script>
    <script src="/js/analytics-enhanced.js" defer></script>
    <script src="/js/structured-data.js" defer></script>
    <script src="/js/cart-abandonment.js" defer></script>
    <script src="/js/mobile-cta.js" defer></script>
    <script src="/js/premium-icons.js" defer></script>
</head>
<body class="antialiased">

                            <!-- Standardized Navigation -->
    <nav class="fixed top-0 w-full bg-charcoal/90 backdrop-blur-sm border-b border-bone/10 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex items-center justify-between">
                <!-- Brand Logo -->
                <div class="font-display font-bold text-lg sm:text-xl">
                    <a href="index.html" class="text-bone hover:text-red-flag transition-colors">Aleks Filmore</a>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="hidden md:flex items-center space-x-6 lg:space-x-8">
                    <a href="audiobook.html" class="nav-link hover-underline-slide">Audiobook</a>
                    <a href="shop.html" class="nav-link hover-underline-slide">Shop</a>
                    <a href="reviews.html" class="nav-link hover-underline-slide">Reviews</a>
                    <a href="bad-date-bingo.html" class="nav-link hover-underline-slide">Bingo Game</a>
                    <a href="about.html" class="nav-link hover-underline-slide">About</a>
                    <a href="contact.html" class="nav-link hover-underline-slide">Contact</a>
                    <a href="dacia-rising.html" class="nav-link hover-underline-slide text-sm opacity-75 hover:opacity-100">Dacia Rising</a>
                    <a href="midway.html" class="text-xs opacity-50 hover:opacity-100 transition-opacity">
                        <svg class="premium-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 3C8 3 8 9 12 9s4-6 12-6"/>
                            <path d="M12 21c4 0 4-6 0-6s-4 6 0 6"/>
                            <path d="M3 12c0-4 6-4 6 0s-6 4-6 0"/>
                            <path d="M21 12c0-4-6-4-6 0s6 4 6 0"/>
                            <circle cx="12" cy="12" r="2"/>
                        </svg>
                    </a>
                </div>
                
                <!-- Mobile Menu Toggle -->
                <div class="md:hidden">
                    <button id="mobile-menu-toggle" class="text-bone hover:text-red-flag transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden bg-charcoal/95 backdrop-blur-sm border-t border-bone/10">
            <div class="px-4 py-6 space-y-4">
                <a href="audiobook.html" class="block text-lg nav-link">Audiobook</a>
                <a href="shop.html" class="block text-lg nav-link">Shop</a>
                <a href="reviews.html" class="block text-lg nav-link">Reviews</a>
                <a href="bad-date-bingo.html" class="block text-lg nav-link">Bingo Game</a>
                <a href="about.html" class="block text-lg nav-link">About</a>
                <a href="contact.html" class="block text-lg nav-link">Contact</a>
                <a href="dacia-rising.html" class="block nav-link opacity-75">Dacia Rising</a>
                <a href="midway.html" class="block text-sm nav-link opacity-50">
                    <svg class="premium-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 3C8 3 8 9 12 9s4-6 12-6"/>
                        <path d="M12 21c4 0 4-6 0-6s-4 6 0 6"/>
                        <path d="M3 12c0-4 6-4 6 0s-6 4-6 0"/>
                        <path d="M21 12c0-4-6-4-6 0s6 4 6 0"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>
                    Hall of Red Flags
                </a>
            </div>
        </div>
    </nav>
    <!-- Mobile Menu Toggle Script -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        
        if (mobileMenuToggle && mobileMenu) {
            mobileMenuToggle.addEventListener('click', function() {
                mobileMenu.classList.toggle('hidden');
            });
            
            // Close mobile menu when clicking on a link
            const mobileLinks = mobileMenu.querySelectorAll('a');
            mobileLinks.forEach(link => {
                link.addEventListener('click', function() {
                    mobileMenu.classList.add('hidden');
                });
            });
            
            // Close mobile menu when clicking outside
            document.addEventListener('click', function(event) {
                if (!mobileMenuToggle.contains(event.target) && !mobileMenu.contains(event.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
        }
    });
    </script>

    <!-- Main Content -->
    <main class="pt-20 pb-12 min-h-screen">
        <div class="container mx-auto px-4 sm:px-6">
            <div class="max-w-2xl mx-auto">
                
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="font-display font-bold text-3xl sm:text-4xl mb-4">
                        Complete Your <span class="text-red-flag">Order</span>
                    </h1>
                    <p class="text-bone/80 text-lg">
                        Add your details and any custom requests before secure checkout
                    </p>
                </div>

                <!-- Checkout Form -->
                <div class="checkout-card p-6 sm:p-8">
                    
                    <!-- Product Summary -->
                    <div id="product-summary" class="mb-8 pb-6 border-b border-bone/20">
                        <!-- Product info will be populated by JavaScript -->
                    </div>

                    <!-- Custom Note Section (for physical products) -->
                    <div id="custom-note-section" class="mb-8" style="display: none;">
                        <h3 class="font-display font-semibold text-xl mb-4">Custom Note/Dedication</h3>
                        <p class="text-bone/70 text-sm mb-4">
                            Would you like a custom dedication or note with your signed copy? (Optional)
                        </p>
                        <textarea 
                            id="custom-note" 
                            class="form-input" 
                            rows="3" 
                            maxlength="200"
                            placeholder="e.g., 'To Sarah, Happy Birthday! - Aleks' or 'For my book club - can't wait to discuss!'"
                        ></textarea>
                        <div class="text-xs text-bone/50 mt-2">
                            <span id="char-count">0</span>/200 characters
                        </div>
                    </div>

                    <!-- Email for Digital Products -->
                    <div id="email-section" class="mb-8">
                        <h3 class="font-display font-semibold text-xl mb-4">Contact Information</h3>
                        <div class="mb-4">
                            <label for="customer-email" class="block text-sm font-medium mb-2">Email Address</label>
                            <input 
                                type="email" 
                                id="customer-email" 
                                class="form-input" 
                                required
                                placeholder="your@email.com"
                            >
                            <p class="text-xs text-bone/60 mt-1">We'll send your order confirmation and any digital products to this email.</p>
                        </div>
                    </div>

                    <!-- Newsletter Signup -->
                    <div class="mb-8 p-4 bg-glitch-lime/10 border border-glitch-lime/30 rounded-lg">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="newsletter-signup" class="form-checkbox text-red-flag">
                            <div>
                                <div class="font-medium">🚩 Join the Red Flag Report (Optional)</div>
                                <div class="text-sm text-bone/70">Get updates on new books, exclusive content, and dating disaster stories. Unsubscribe anytime.</div>
                            </div>
                        </label>
                    </div>

                    <!-- Checkout Button -->
                    <div class="space-y-4">
                        <!-- Refunds Policy Notice -->
                        <div class="p-4 bg-red-flag/10 border border-red-flag/30 rounded-lg mb-4">
                            <div class="flex items-start space-x-3">
                                <div class="text-red-flag text-lg"><svg class="premium-icon colored-red" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg></div>
                                <div>
                                    <div class="font-medium text-sm">Important: All Sales Are Final</div>
                                    <div class="text-xs text-bone/70 mt-1">
                                        We do not offer refunds for digital products or personalized signed copies. 
                                        By proceeding, you agree to our <a href="terms.html" class="text-red-flag hover:underline" target="_blank">Terms & Conditions</a>.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="checkout-button" class="btn-primary" onclick="proceedToStripe()">
                            <span id="checkout-text">Continue to Secure Payment</span>
                            <div id="checkout-spinner" class="loading-spinner ml-2"></div>
                        </button>
                        
                        <p class="text-xs text-center text-bone/60">
                            🔒 Secure payment powered by Stripe. Your payment information is encrypted and never stored on our servers.
                        </p>
                        
                        <div class="text-center">
                            <a href="shop.html" class="text-bone/60 hover:text-red-flag transition-colors text-sm">
                                ← Back to Shop
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-charcoal/50 border-t border-bone/10 py-8">
        <div class="container mx-auto px-4 sm:px-6 text-center">
            <p class="text-bone/60 text-sm">
                &copy; 2025 Aleks Filmore. Secure checkout powered by Stripe. 
                <a href="privacy.html" class="text-red-flag hover:text-glitch-lime">Privacy</a> | 
                <a href="terms.html" class="text-red-flag hover:text-glitch-lime">Terms</a>
            </p>
        </div>
    </footer>

    <script>
        // Product configurations
        const products = {
            'audiobook': {
                name: 'The Worst Boyfriends Ever (Audiobook)',
                price: 7.99,
                discountedPrice: 6.39,
                type: 'digital',
                stripeUrl: 'https://buy.stripe.com/6oUfZa3ZW00q66g0x79fW00',
                discountUrl: 'https://buy.stripe.com/5kQ5kw3ZWfZoeCMfs19fW03',
                description: 'Digital audiobook with exclusive bonus epilogue'
            },
            'signed-book': {
                name: 'The Worst Boyfriends Ever (Signed Paperback)',
                price: 19.99,
                discountedPrice: 15.99,
                type: 'physical',
                stripeUrl: 'https://buy.stripe.com/28E3codAw4gG0LW6Vv9fW01',
                discountUrl: 'https://buy.stripe.com/cNibIU8gcaF47ak7Zz9fW05',
                description: 'Personally signed paperback with handwritten note'
            },
            'bundle': {
                name: 'Complete Bundle (Audiobook + Signed Paperback)',
                price: 24.99,
                discountedPrice: 19.99,
                type: 'bundle',
                stripeUrl: 'https://buy.stripe.com/9B66oA0NKdRgamw4Nn9fW02',
                discountUrl: 'https://buy.stripe.com/3cI7sE9kg8wW8eo6Vv9fW04',
                description: 'Both audiobook and signed paperback together'
            }
        };

        let currentProduct = null;

        // Get product from URL parameters
        function getProductFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product');
            
            if (productId && products[productId]) {
                currentProduct = products[productId];
                currentProduct.id = productId;
                return true;
            }
            return false;
        }

        // Initialize page
        function initializePage() {
            if (!getProductFromURL()) {
                // Redirect to shop if no valid product
                window.location.href = 'shop.html';
                return;
            }

            displayProductSummary();
            setupCustomNoteSection();
            setupCharacterCounter();
        }

        // Display product summary
        function displayProductSummary() {
            const summaryDiv = document.getElementById('product-summary');
            summaryDiv.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-display font-semibold text-xl">${currentProduct.name}</h3>
                        <p class="text-bone/70 text-sm">${currentProduct.description}</p>
                    </div>
                    <div class="price-tag text-lg">$${currentProduct.price.toFixed(2)}</div>
                </div>
                ${currentProduct.type === 'physical' || currentProduct.type === 'bundle' ? 
                    '<p class="text-xs text-bone/60">+ shipping calculated by Stripe</p>' : 
                    '<p class="text-xs text-bone/60">Instant digital delivery</p>'
                }
            `;
        }

        // Setup custom note section
        function setupCustomNoteSection() {
            const noteSection = document.getElementById('custom-note-section');
            
            if (currentProduct.type === 'physical' || currentProduct.type === 'bundle') {
                noteSection.style.display = 'block';
            } else {
                noteSection.style.display = 'none';
            }
        }

        // Setup character counter
        function setupCharacterCounter() {
            const textarea = document.getElementById('custom-note');
            const counter = document.getElementById('char-count');
            
            if (textarea && counter) {
                textarea.addEventListener('input', function() {
                    const count = this.value.length;
                    counter.textContent = count;
                    
                    if (count > 180) {
                        counter.style.color = 'var(--color-red-flag)';
                    } else {
                        counter.style.color = 'rgba(247, 243, 237, 0.5)';
                    }
                });
            }
        }

        // Proceed to Stripe checkout
        async function proceedToStripe() {
            const checkoutButton = document.getElementById('checkout-button');
            const checkoutText = document.getElementById('checkout-text');
            const checkoutSpinner = document.getElementById('checkout-spinner');
            const emailInput = document.getElementById('customer-email');
            const customNote = document.getElementById('custom-note');
            const newsletterSignup = document.getElementById('newsletter-signup');

            // Validate email
            if (!emailInput.value || !emailInput.value.includes('@')) {
                alert('Please enter a valid email address.');
                emailInput.focus();
                return;
            }

            // Show loading state
            checkoutButton.disabled = true;
            checkoutText.textContent = 'Processing...';
            checkoutSpinner.style.display = 'inline-block';

            try {
                // Collect order data
                const orderData = {
                    product: currentProduct.id,
                    email: emailInput.value,
                    customNote: customNote ? customNote.value : null,
                    newsletterSignup: newsletterSignup.checked,
                    timestamp: new Date().toISOString()
                };

                // Store order data for admin panel (in a real app, this would go to your database)
                const existingOrders = JSON.parse(localStorage.getItem('pending_orders') || '[]');
                existingOrders.push({
                    id: 'temp_' + Date.now(),
                    ...orderData,
                    status: 'pending_payment'
                });
                localStorage.setItem('pending_orders', JSON.stringify(existingOrders));

                // Handle newsletter signup
                if (newsletterSignup.checked) {
                    await submitToFormspree(emailInput.value);
                }

                // Determine which Stripe URL to use (regular or discounted)
                let stripeUrl;
                const discountCode = localStorage.getItem('discount_code');
                const discountExpiry = localStorage.getItem('discount_expiry');
                
                // Check if discount code is valid and not expired
                const hasValidDiscount = discountCode && 
                                       discountExpiry && 
                                       Date.now() < parseInt(discountExpiry) &&
                                       currentProduct.discountUrl &&
                                       !currentProduct.discountUrl.includes('PLACEHOLDER');
                
                // Debug logging
                console.log('💳 Checkout Debug:', {
                    discountCode,
                    discountExpiry,
                    discountValid: discountCode && discountExpiry && Date.now() < parseInt(discountExpiry),
                    hasDiscountUrl: !!currentProduct.discountUrl,
                    discountUrl: currentProduct.discountUrl,
                    regularUrl: currentProduct.stripeUrl,
                    hasValidDiscount,
                    currentProduct: currentProduct.name,
                    timeUntilExpiry: discountExpiry ? Math.round((parseInt(discountExpiry) - Date.now()) / 1000 / 60) + ' minutes' : 'N/A'
                });
                
                if (hasValidDiscount) {
                    stripeUrl = currentProduct.discountUrl;
                    console.log(`🎉 DISCOUNT APPLIED! Using discounted link for ${discountCode}`);
                    console.log(`🔗 Discount URL: ${stripeUrl}`);
                    console.log(`💰 Price: $${currentProduct.price} → $${currentProduct.discountedPrice}`);
                    
                    // Track discount usage
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'discount_code_used', {
                            event_category: 'Conversion',
                            event_label: discountCode,
                            value: currentProduct.price - currentProduct.discountedPrice
                        });
                    }
                    
                    // Clear discount after use (single-use)
                    localStorage.removeItem('discount_code');
                    localStorage.removeItem('discount_expiry');
                } else {
                    stripeUrl = currentProduct.stripeUrl;
                    console.log('❌ NO DISCOUNT - Using regular price link');
                    console.log(`🔗 Regular URL: ${stripeUrl}`);
                    console.log(`💰 Full Price: $${currentProduct.price}`);
                    
                    if (discountCode && !hasValidDiscount) {
                        console.log('⚠️ Discount code found but not valid:', {
                            code: discountCode,
                            expired: discountExpiry && Date.now() >= parseInt(discountExpiry),
                            noDiscountUrl: !currentProduct.discountUrl,
                            isPlaceholder: currentProduct.discountUrl && currentProduct.discountUrl.includes('PLACEHOLDER')
                        });
                    }
                }
                
                // Legacy discount handling (fallback for manual refunds)
                if (discountCode && !hasValidDiscount) {
                    // Store discount info for manual processing if no discounted link available
                    localStorage.setItem('pending_discount', JSON.stringify({
                        email: emailInput.value,
                        code: discountCode,
                        amount: getDiscountAmount(currentProduct.price),
                        timestamp: Date.now()
                    }));
                    
                    // Add discount note to custom note for manual processing
                    const discountNote = `DISCOUNT CODE: ${discountCode} - 20% refund requested`;
                    if (customNote && customNote.value) {
                        customNote.value += '\n\n' + discountNote;
                    } else if (customNote) {
                        customNote.value = discountNote;
                    }
                }
                
                if (customNote && customNote.value && (currentProduct.type === 'physical' || currentProduct.type === 'bundle')) {
                    // Keep local fallback copy for manual reconciliation
                    localStorage.setItem('custom_note_' + Date.now(), JSON.stringify({
                        email: emailInput.value,
                        note: customNote.value,
                        product: currentProduct.id
                    }));
                }

                // Preferred flow: create Checkout Session server-side so metadata is preserved and available to webhooks
                try {
                    const payload = {
                        product: currentProduct.id,
                        email: emailInput.value,
                        customNote: customNote ? customNote.value : null,
                        newsletterSignup: newsletterSignup.checked,
                        discountCode: discountCode || null
                    };

                    console.log('Posting to /.netlify/functions/create-checkout-session', payload);

                    const resp = await fetch('/.netlify/functions/create-checkout-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        throw new Error(err.error || 'Failed to create checkout session');
                    }

                    const data = await resp.json();
                    if (data && data.url) {
                        console.log('Redirecting to Stripe session URL:', data.url);
                        window.location.href = data.url;
                        return;
                    } else if (data && data.id) {
                        // Fallback: redirect to success url if session url missing
                        window.location.href = `${window.location.origin}/checkout-success.html?session_id=${encodeURIComponent(data.id)}`;
                        return;
                    } else {
                        throw new Error('No session URL returned');
                    }
                } catch (err) {
                    console.error('Failed to create checkout session, falling back to direct Stripe link:', err);
                    // Final fallback: redirect to raw Stripe link
                    window.location.href = stripeUrl;
                    return;
                }

            } catch (error) {
                console.error('Checkout error:', error);
                alert('There was an error processing your order. Please try again.');
            } finally {
                // Reset button state
                checkoutButton.disabled = false;
                checkoutText.textContent = 'Continue to Secure Payment';
                checkoutSpinner.style.display = 'none';
            }
        }

        // Discount handling functions
        function checkForDiscount() {
            const urlParams = new URLSearchParams(window.location.search);
            const discountParam = urlParams.get('discount');
            
            if (discountParam) {
                localStorage.setItem('discount_code', discountParam);
                localStorage.setItem('discount_expiry', (Date.now() + 24 * 60 * 60 * 1000).toString());
            }
            
            const discountCode = localStorage.getItem('discount_code');
            const discountExpiry = localStorage.getItem('discount_expiry');
            
            if (discountCode && discountExpiry && Date.now() < parseInt(discountExpiry)) {
                showDiscountSection(discountCode);
            }
        }
        
        function showDiscountSection(code) {
            const discountSection = document.getElementById('discount-section');
            const appliedCodeElement = document.getElementById('applied-discount-code');
            const discountAmountElement = document.getElementById('discount-amount');
            
            if (discountSection && appliedCodeElement && discountAmountElement) {
                const currentProduct = getCurrentProduct();
                
                // Only show discount for audiobook
                if (!currentProduct || getCurrentProductId() !== 'audiobook') {
                    discountSection.style.display = 'none';
                    return;
                }
                
                appliedCodeElement.textContent = code;
                
                // Calculate discount amount for audiobook only
                if (currentProduct && currentProduct.discountedPrice) {
                    const discountAmount = currentProduct.price - currentProduct.discountedPrice;
                    discountAmountElement.textContent = `-$${discountAmount.toFixed(2)}`;
                    
                    // Update main price display to show discounted price
                    updatePriceDisplay(currentProduct);
                } else {
                    // Fallback to 20% calculation for audiobook only
                    const discountAmount = getDiscountAmount(7.99); // Fixed audiobook price
                    discountAmountElement.textContent = `-$${discountAmount.toFixed(2)}`;
                }
                
                discountSection.style.display = 'block';
            }
        }
        
        function updatePriceDisplay(product) {
            const priceElement = document.querySelector('#product-price');
            if (priceElement && product.discountedPrice) {
                priceElement.innerHTML = `
                    <span class="line-through text-bone/50">$${product.price.toFixed(2)}</span>
                    <span class="text-green-400 font-bold">$${product.discountedPrice.toFixed(2)}</span>
                `;
            }
        }
        
        function getDiscountAmount(price) {
            return price * 0.20; // 20% discount
        }
        
        function removeDiscount() {
            localStorage.removeItem('discount_code');
            localStorage.removeItem('discount_expiry');
            document.getElementById('discount-section').style.display = 'none';
        }
        
        function getCurrentProduct() {
            return window.currentProduct || products.audiobook; // fallback
        }
        
        function getCurrentProductId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('product') || 'audiobook';
        }

        // Submit email to Formspree for newsletter
        async function submitToFormspree(email) {
            try {
                const response = await fetch('https://formspree.io/f/myzjjjjp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        _subject: 'New Newsletter Subscription from Checkout',
                        source: 'Checkout Page'
                    })
                });
                
                console.log('Newsletter signup submitted');
            } catch (error) {
                console.error('Newsletter signup error:', error);
            }
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            checkForDiscount(); // Check for discount codes
        });
    </script>

    <!-- Enhanced Features Scripts -->
    <script src="/js/trust-badges.js"></script>
    <script src="/js/analytics-enhanced.js"></script>
    
    <!-- Cookie Notice JavaScript -->
    <script src="js/cookie-notice.js"></script>

</body>
</html>
