<!DOCTYPE html>
<h            'bundle': {
                name: 'Complete Bundle (Audiobook + Signed Paperback)', 
                price: 24.99,
                type: 'bundle',lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Enhanced SEO Meta Tags -->
    <title>Secure Checkout | Aleks Film                        </div>
                    </div>

                    <!-- Discount Code Section -->
                    <div id="discount-section" class="mb-8" style="display: none;">
               'signed-book': {
                name: 'The Worst Boyfriends Ever (Signed Paperback)',
                price: 19.99,
                type: 'physical',
                stripeUrl: 'https://buy.stripe.com/28E3codAw4gG0LW6Vv9fW01',
                description: 'Personally signed paperback with handwritten note'
            },
            'bundle': {
                name: 'Complete Bundle (Audiobook + Signed Paperback)',
                price: 22.99,
                type: 'bundle',
                stripeUrl: 'https://buy.stripe.com/9B66oA0NKdRgamw4Nn9fW02',
                description: 'Both audiobook and signed paperback together'
            }   <h3 class="font-display font-semibold text-xl mb-4"><svg class="premium-icon colored-lime" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"/>
        <path d="M16 8h-6a2 2 0 1 0 0 4h4a2 2 0 1 1 0 4H8"/>
        <path d="M12 18V6"/>
    </svg> Discount Code</h3>
                        <div class="discount-code-container p-4 bg-green-500/10 border border-green-500/30 rounded-lg">
                            <div class="flex items-center justify-between mb-3">
                                <span class="font-semibold text-green-400"><svg class="premium-icon colored-lime" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M8 2v4l-3 2v4h18V8l-3-2V2"/>
        <path d="M16 4V2"/>
        <path d="M12 4V2"/>
        <path d="M8 4V2"/>
        <path d="M8 22l8-10H8l8-10"/>
    </svg> 20% OFF Applied!</span>
                                <span id="discount-amount" class="font-bold text-green-400">-$1.60</span>
                            </div>
                            <div class="flex items-center justify-between text-sm">
                                <span>Code: <code id="applied-discount-code" class="bg-charcoal/50 px-2 py-1 rounded"></code></span>
                                <button onclick="removeDiscount()" class="text-red-500 hover:text-red-400 text-xs">Remove</button>
                            </div>
                            <div class="text-xs text-bone/60 mt-2">
                                Discount will be refunded after payment processing
                            </div>
                        </div>
                    </div>

                    <!-- Newsletter Signup -->
                    <div class="mb-8 p-4 bg-glitch-lime/10 border border-glitch-lime/30 rounded-lg">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="newsletter-signup" class="form-checkbox text-red-flag">
                            <div>
                                <div class="font-medium">üö© Join the Red Flag Report (Optional)</div>
                                <div class="text-sm text-bone/70">Get updates on new books, exclusive content, and dating disaster stories. Unsubscribe anytime.</div>
                            </div>
                        </label>
                    }e Your Purchase</title>
    <meta name="description" content="Complete your purchase securely with Stripe. Add custom notes and dedication requests for signed copies of The Worst Boyfriends Ever.">
    <!-- Wikidata Identifier -->
    <meta property="wikidata:QID" content="Q136592649">
    <meta name="identifier" content="wikidata:Q136592649">

    <meta name="keywords" content="checkout, secure payment, Stripe payment, custom dedication, signed book purchase, Aleks Filmore">
    <meta name="author" content="Aleks Filmore">
    <meta name="robots" content="noindex, nofollow">

    <!-- Canonical URL -->
    <link rel="canonical" href="https://aleksfilmore.com/checkout.html">
    
    <!-- Google Analytics dynamic loader (no hardcoded ID) -->
    <script>window.GA_MEASUREMENT_ID = window.GA_MEASUREMENT_ID || undefined;</script>
    
    
    <!-- Tailwind CSS -->
    <!-- Tailwind CSS -->
    <link rel="stylesheet" href="/css/tailwind.min.css">
    
    <!-- Logo Styles -->
    <link rel="stylesheet" href="/css/logo.css">
    
    <!-- Cookie Notice CSS -->
    <link rel="stylesheet" href="/css/cookie-notice.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            /* V2 Primary Colors */
            --v2-black: #010300;
            --v2-cream: #f0e8c9;
            --v2-red: #fd0009;
            --v2-gray: #bfb9a3;
            
            /* Legacy Mappings */
            --color-charcoal: #010300;
            --color-bone: #f0e8c9;
            --color-red-flag: #fd0009;
            --color-glitch-lime: #C7FF41;
            --color-dusty-blush: #F1B7C4;
            --font-display: 'Space Grotesk', sans-serif;
            --font-body: 'Inter', sans-serif;
        }
        
        .logo-svg {
            height: 60px;
        }
        
        @media (max-width: 768px) {
            .logo-svg {
                height: 50px;
            }
        }

        body {
            background: linear-gradient(135deg, var(--color-charcoal) 0%, #1a1a1a 100%);
            font-family: var(--font-body);
            color: var(--color-bone);
            line-height: 1.6;
        }

        .font-display { font-family: var(--font-display); }

        .checkout-card {
            background: linear-gradient(135deg, rgba(247, 243, 237, 0.08) 0%, rgba(247, 243, 237, 0.04) 100%);
            border: 1px solid rgba(247, 243, 237, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .form-input {
            background: rgba(247, 243, 237, 0.1);
            border: 1px solid rgba(247, 243, 237, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--color-bone);
            width: 100%;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            border-color: var(--color-red-flag);
            outline: none;
        }

        .form-input::placeholder {
            color: rgba(247, 243, 237, 0.5);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-red-flag) 0%, #e63946 100%);
            color: var(--color-bone);
            font-family: var(--font-display);
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            box-shadow: 0 4px 16px rgba(255, 59, 59, 0.25);
            width: 100%;
            cursor: pointer;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 59, 59, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: transparent;
            color: var(--color-bone);
            font-family: var(--font-display);
            font-weight: 600;
            padding: 1rem 2rem;
            border-radius: 12px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--color-bone);
        }
        
        .btn-secondary:hover {
            background: var(--color-bone);
            color: var(--color-charcoal);
            transform: translateY(-1px);
        }

        .price-tag {
            background: linear-gradient(135deg, var(--color-red-flag) 0%, #e63946 100%);
            color: var(--color-bone);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            box-shadow: 0 4px 12px rgba(255, 59, 59, 0.3);
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-bone);
            border-top: 2px solid var(--color-red-flag);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Optimization Scripts -->
    <script src="/js/image-optimizer.js" defer></script>
    <script src="/js/social-proof.js" defer></script>
    <script src="/js/exit-intent.js" defer></script>
    <script src="/js/trust-badges.js" defer></script>
    
    <script src="/js/structured-data.js" defer></script>
    <script src="/js/cart-abandonment.js" defer></script>
    <script src="/js/mobile-cta.js" defer></script>
    <script src="/js/newsletter-popup-manager.js" defer></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (window.mobileCTA && window.NewsletterPopupManager) {
                    // MobileCTA already has the correct showNewsletterPopup method
                    // No override needed
                }
            }, 100);
        });
    </script>
    <script src="/js/premium-icons.js" defer></script>
    <script src="/js/mobile-menu.js" defer></script>
</head>
<body class="antialiased">

                            <!-- Standardized Navigation -->
    <!-- V2 Unified Navigation -->
    <nav class="fixed top-0 w-full bg-[#010300]/95 backdrop-blur-sm border-b border-[#f0e8c9]/10 z-50">
        <div class="container mx-auto px-4 sm:px-6 py-3 sm:py-4">
            <div class="flex items-center justify-between">
                <div class="aleksfilmore-logo-container">
                    <a href="index.html" class="aleksfilmore-logo-link">
                        <svg viewBox="0 0 1200 220" xmlns="http://www.w3.org/2000/svg" class="logo-svg">
                            <title>Aleks Filmore ‚Äî Author</title>
                            <text x="40" y="110" font-family="Space Grotesk, Arial, sans-serif" font-size="96" letter-spacing="4" fill="#f0e8c9" font-weight="700">ALEKS FILMORE</text>
                            <rect x="40" y="140" width="140" height="10" fill="#fd0009" rx="5"/>
                            <text x="190" y="150" font-family="Inter, Arial, sans-serif" font-size="24" letter-spacing="8" fill="#f0e8c9" font-weight="600">AUTHOR</text>
                        </svg>
                    </a>
                </div>
                <div class="hidden md:flex items-center space-x-6 lg:space-x-8">
                    <a href="books.html" class="nav-link hover-underline-slide">Books</a>
                    <a href="press.html" class="nav-link hover-underline-slide">Press</a>
                    <a href="blog.html" class="nav-link hover-underline-slide">Blog</a>
                    <a href="newsletter.html" class="nav-link hover-underline-slide">Newsletter</a>
                    <a href="about.html" class="nav-link hover-underline-slide">About</a>
                    <a href="contact.html" class="nav-link hover-underline-slide">Contact</a>
                </div>
                <div class="md:hidden">
                    <button id="mobile-menu-toggle" aria-controls="mobile-menu" aria-expanded="false" aria-label="Toggle menu" class="text-[#f0e8c9] hover:text-[#fd0009] transition-colors">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div id="mobile-menu" class="hidden md:hidden bg-[#010300]/95 backdrop-blur-sm border-t border-[#f0e8c9]/10">
            <div class="px-4 py-6 space-y-4">
                <a href="books.html" class="block text-lg nav-link">Books</a>
                <a href="press.html" class="block text-lg nav-link">Press</a>
                <a href="blog.html" class="block text-lg nav-link">Blog</a>
                <a href="newsletter.html" class="block text-lg nav-link">Newsletter</a>
                <a href="about.html" class="block text-lg nav-link">About</a>
                <a href="contact.html" class="block text-lg nav-link">Contact</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="pt-20 pb-12 min-h-screen">
        <div class="container mx-auto px-4 sm:px-6">
            <div class="max-w-2xl mx-auto">
                
                <!-- Header -->
                <div class="text-center mb-8">
                    <h1 class="font-display font-bold text-3xl sm:text-4xl mb-4">
                        Complete Your <span class="text-red-flag">Order</span>
                    </h1>
                    <p class="text-bone/80 text-lg">
                        Add your details and any custom requests before secure checkout
                    </p>
                </div>

                <!-- Checkout Form -->
                <div class="checkout-card p-6 sm:p-8">
                    
                    <!-- Product Summary -->
                    <div id="product-summary" class="mb-8 pb-6 border-b border-bone/20">
                        <!-- Product info will be populated by JavaScript -->
                    </div>

                    <!-- Custom Note Section (for physical products) -->
                    <div id="custom-note-section" class="mb-8" style="display: none;">
                        <h3 class="font-display font-semibold text-xl mb-4">Custom Note/Dedication</h3>
                        <p class="text-bone/70 text-sm mb-4">
                            Would you like a custom dedication or note with your signed copy? (Optional)
                        </p>
                        <textarea 
                            id="custom-note" 
                            class="form-input" 
                            rows="3" 
                            maxlength="200"
                            placeholder="e.g., 'To Sarah, Happy Birthday! - Aleks' or 'For my book club - can't wait to discuss!'"
                        ></textarea>
                        <div class="text-xs text-bone/50 mt-2">
                            <span id="char-count">0</span>/200 characters
                        </div>
                    </div>

                    <!-- Email for Digital Products -->
                    <div id="email-section" class="mb-8">
                        <h3 class="font-display font-semibold text-xl mb-4">Contact Information</h3>
                        <div class="mb-4">
                            <label for="customer-email" class="block text-sm font-medium mb-2">Email Address</label>
                            <input 
                                type="email" 
                                id="customer-email" 
                                class="form-input" 
                                required
                                placeholder="your@email.com"
                            >
                            <p class="text-xs text-bone/60 mt-1">We'll send your order confirmation and any digital products to this email.</p>
                        </div>
                    </div>

                    <!-- Newsletter Signup -->
                    <div class="mb-8 p-4 bg-glitch-lime/10 border border-glitch-lime/30 rounded-lg">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" id="newsletter-signup" class="form-checkbox text-red-flag">
                            <div>
                                <div class="font-medium">üö© Join the Red Flag Report (Optional)</div>
                                <div class="text-sm text-bone/70">Get updates on new books, exclusive content, and dating disaster stories. Unsubscribe anytime.</div>
                            </div>
                        </label>
                    </div>

                    <!-- Checkout Button -->
                    <div class="space-y-4">
                        <!-- Refunds Policy Notice -->
                        <div class="p-4 bg-red-flag/10 border border-red-flag/30 rounded-lg mb-4">
                            <div class="flex items-start space-x-3">
                                <div class="text-red-flag text-lg"><svg class="premium-icon colored-red" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/>
        <line x1="12" y1="9" x2="12" y2="13"/>
        <line x1="12" y1="17" x2="12.01" y2="17"/>
    </svg></div>
                                <div>
                                    <div class="font-medium text-sm">Important: All Sales Are Final</div>
                                    <div class="text-xs text-bone/70 mt-1">
                                        We do not offer refunds for digital products or personalized signed copies. 
                                        By proceeding, you agree to our <a href="terms.html" class="text-red-flag hover:underline" target="_blank">Terms & Conditions</a>.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button id="checkout-button" class="btn-primary" onclick="proceedToStripe()">
                            <span id="checkout-text">Continue to Secure Payment</span>
                            <div id="checkout-spinner" class="loading-spinner ml-2"></div>
                        </button>
                        
                        <p class="text-xs text-center text-bone/60">
                            üîí Secure payment powered by Stripe. Your payment information is encrypted and never stored on our servers.
                        </p>
                        
                        <div class="text-center">
                            <a href="shop.html" class="text-bone/60 hover:text-red-flag transition-colors text-sm">
                                ‚Üê Back to Shop
                            </a>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- Footer -->
    <!-- Enhanced Footer -->
    <footer class="relative bg-gradient-to-b from-charcoal/80 to-charcoal border-t border-bone/20 py-12 sm:py-16 overflow-hidden">
        <!-- Background Elements -->
        <div class="absolute inset-0 pointer-events-none">
            <div class="absolute top-0 left-0 w-full h-px bg-gradient-to-r from-transparent via-red-flag/30 to-transparent"></div>
            <div class="absolute bottom-0 right-0 w-32 h-32 bg-glitch-lime/5 rounded-full blur-3xl"></div>
            <div class="absolute top-0 left-0 w-24 h-24 bg-dusty-blush/5 rounded-full blur-2xl"></div>
        </div>
        
        <div class="container mx-auto px-4 sm:px-6 relative z-10">
            <!-- Main Footer Content -->
            <div class="grid grid-cols-2 md:grid-cols-5 gap-8 sm:gap-12 mb-12 sm:mb-16">
                <!-- Brand Section -->
                <div class="col-span-2 md:col-span-2">
                    <div class="mb-6">
                        <h4 class="font-display font-bold text-xl sm:text-2xl mb-4 text-bone">
                            Aleks Filmore
                        </h4>
                        <p class="text-bone/70 text-sm sm:text-base leading-relaxed mb-6">
                            Honest to a fault, funny on purpose. Red flags processed in Brussels, delivered worldwide.
                        </p>
                    </div>
                    
                    <!-- Social Links -->
                    <div class="flex items-center gap-4">
                        <a href="https://instagram.com/aleksfilmore" 
                           target="_blank" 
                           class="group p-3 bg-bone/5 hover:bg-red-flag/20 rounded-full transition-all duration-300 hover:scale-110">
                            <svg class="w-5 h-5 text-bone/60 group-hover:text-red-flag transition-colors" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12.017 0C8.396 0 7.939.016 6.71.078 5.481.14 4.65.301 3.927.63c-.789.306-1.459.717-2.126 1.384S.935 3.35.63 4.14C.301 4.863.14 5.694.078 6.923.016 8.152 0 8.609 0 12.017s.016 3.865.078 5.094c.062 1.229.223 2.06.552 2.783.306.789.717 1.459 1.384 2.126s1.337 1.078 2.126 1.384c.723.329 1.554.49 2.783.552 1.229.062 1.686.078 5.094.078s3.865-.016 5.094-.078c1.229-.062 2.06-.223 2.783-.552.789-.306 1.459-.717 2.126-1.384s1.078-1.337 1.384-2.126c.329-.723.49-1.554.552-2.783.062-1.229.078-1.686.078-5.094s-.016-3.865-.078-5.094c-.062-1.229-.223-2.06-.552-2.783-.306-.789-.717-1.459-1.384-2.126S19.65.935 18.861.63C18.138.301 17.307.14 16.078.078 14.849.016 14.392 0 12.017 0zM12.017 2.17c3.291 0 3.683.013 4.947.072 1.194.055 1.843.249 2.274.413.572.222.98.487 1.41.916.43.43.694.838.916 1.41.164.431.358 1.08.413 2.274.059 1.264.072 1.656.072 4.947s-.013 3.683-.072 4.947c-.055 1.194-.249 1.843-.413 2.274-.222.572-.487.98-.916 1.41-.43.43-.838.694-1.41.916-.431.164-1.08.358-2.274.413-1.264.059-1.656.072-4.947.072s-3.683-.013-4.947-.072c-1.194-.055-1.843-.249-2.274-.413-.572-.222-.98-.487-1.41-.916-.43-.43-.694-.838-.916-1.41-.164-.431-.358-1.08-.413-2.274-.059-1.264-.072-1.656-.072-4.947s.013-3.683.072-4.947c.055-1.194.249-1.843.413-2.274.222-.572.487-.98.916-1.41.43-.43.838-.694 1.41-.916.431-.164 1.08-.358 2.274-.413 1.264-.059 1.656-.072 4.947-.072z"/>
                                <path d="M12.017 5.838A6.179 6.179 0 1 0 18.196 12 6.179 6.179 0 0 0 12.017 5.838zM12.017 16A4 4 0 1 1 16.017 12a4 4 0 0 1-4 4z"/>
                                <circle cx="18.406" cy="5.594" r="1.44"/>
                            </svg>
                        </a>
                        <a href="https://tiktok.com/@aleksfilmore" 
                           target="_blank" 
                           class="group p-3 bg-bone/5 hover:bg-red-flag/20 rounded-full transition-all duration-300 hover:scale-110">
                            <svg class="w-5 h-5 text-bone/60 group-hover:text-red-flag transition-colors" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.4-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/>
                            </svg>
                        </a>
                        <a href="https://aleksfilmore.substack.com" 
                           target="_blank" 
                           class="group p-3 bg-bone/5 hover:bg-red-flag/20 rounded-full transition-all duration-300 hover:scale-110">
                            <span class="text-sm font-bold text-bone/60 group-hover:text-red-flag transition-colors">S</span>
                        </a>
                        <a href="https://medium.com/@aleksfilmore" 
                           target="_blank" 
                           class="group p-3 bg-bone/5 hover:bg-red-flag/20 rounded-full transition-all duration-300 hover:scale-110">
                            <span class="text-sm font-bold text-bone/60 group-hover:text-red-flag transition-colors">M</span>
                        </a>
                    </div>
                </div>
                
                <!-- Navigation Columns -->
                <div>
                    <h4 class="font-display font-semibold text-base sm:text-lg mb-4 sm:mb-6 text-[#f0e8c9]">Books</h4>
                    <ul class="space-y-3 text-sm sm:text-base">
                        <li><a href="books.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">The Worst Boyfriends Ever</a></li>
                        <li><a href="dacia-rising.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">Dacia Rising</a></li>
                        <li><a href="blog.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">Blog Posts</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-display font-semibold text-base sm:text-lg mb-4 sm:mb-6 text-[#f0e8c9]">Shop</h4>
                    <ul class="space-y-3 text-sm sm:text-base">
                        <li><a href="audiobook.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">Audiobook</a></li>
                        <li><a href="shop.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">Signed Paperbacks</a></li>
                        <li><a href="shop.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">Bundles</a></li>
                    </ul>
                </div>
                
                <div>
                    <h4 class="font-display font-semibold text-base sm:text-lg mb-4 sm:mb-6 text-[#f0e8c9]">Connect</h4>
                    <ul class="space-y-3 text-sm sm:text-base">
                        <li><a href="about.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">About</a></li>
                        <li><a href="contact.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">Contact</a></li>
                        <li><a href="reviews.html" class="text-bone/60 hover:text-red-flag transition-all duration-300 hover:translate-x-1">Reviews</a></li>
                    </ul>
                </div>
            </div>
            
            <!-- Bottom Section -->
            <div class="border-t border-bone/20 pt-8 sm:pt-10">
                <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                    <p class="text-bone/60 text-sm sm:text-base">
                        &copy; 2025 Aleks Filmore. All rights reserved. No refunds, but plenty of regrets.
                    </p>
                    <div class="flex items-center gap-4 text-xs sm:text-sm">
                        <a href="terms.html" class="text-bone/60 hover:text-red-flag transition-colors">Terms</a>
                        <span class="text-bone/30">‚Ä¢</span>
                        <a href="privacy.html" class="text-bone/60 hover:text-red-flag transition-colors">Privacy</a>
                        <span class="text-bone/30">‚Ä¢</span>
                        <a href="cookies.html" class="text-bone/60 hover:text-red-flag transition-colors">Cookies</a>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <script>
        // Product configurations
        const products = {
            'audiobook': {
                name: 'The Worst Boyfriends Ever (Audiobook)',
                price: 7.99,
                discountedPrice: 6.39,
                type: 'digital',
                stripeUrl: 'https://buy.stripe.com/6oUfZa3ZW00q66g0x79fW00',
                discountUrl: 'https://buy.stripe.com/5kQ5kw3ZWfZoeCMfs19fW03',
                description: 'Digital audiobook with exclusive bonus epilogue'
            },
            'signed-book': {
                name: 'The Worst Boyfriends Ever (Signed Paperback)',
                price: 19.99,
                discountedPrice: 15.99,
                type: 'physical',
                stripeUrl: 'https://buy.stripe.com/28E3codAw4gG0LW6Vv9fW01',
                discountUrl: 'https://buy.stripe.com/cNibIU8gcaF47ak7Zz9fW05',
                description: 'Personally signed paperback with handwritten note'
            },
            'bundle': {
                name: 'Complete Bundle (Audiobook + Signed Paperback)',
                price: 24.99,
                discountedPrice: 19.99,
                type: 'bundle',
                stripeUrl: 'https://buy.stripe.com/9B66oA0NKdRgamw4Nn9fW02',
                discountUrl: 'https://buy.stripe.com/3cI7sE9kg8wW8eo6Vv9fW04',
                description: 'Both audiobook and signed paperback together'
            }
        };

        let currentProduct = null;

        // Get product from URL parameters
        function getProductFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('product');
            
            if (productId && products[productId]) {
                currentProduct = products[productId];
                currentProduct.id = productId;
                return true;
            }
            return false;
        }

        // Initialize page
        function initializePage() {
            if (!getProductFromURL()) {
                // Redirect to shop if no valid product
                window.location.href = 'shop.html';
                return;
            }

            displayProductSummary();
            setupCustomNoteSection();
            setupCharacterCounter();
        }

        // Display product summary
        function displayProductSummary() {
            const summaryDiv = document.getElementById('product-summary');
            summaryDiv.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-display font-semibold text-xl">${currentProduct.name}</h3>
                        <p class="text-bone/70 text-sm">${currentProduct.description}</p>
                    </div>
                    <div class="price-tag text-lg">$${currentProduct.price.toFixed(2)}</div>
                </div>
                ${currentProduct.type === 'physical' || currentProduct.type === 'bundle' ? 
                    '<p class="text-xs text-bone/60">+ shipping calculated by Stripe</p>' : 
                    '<p class="text-xs text-bone/60">Instant digital delivery</p>'
                }
            `;
        }

        // Setup custom note section
        function setupCustomNoteSection() {
            const noteSection = document.getElementById('custom-note-section');
            
            if (currentProduct.type === 'physical' || currentProduct.type === 'bundle') {
                noteSection.style.display = 'block';
            } else {
                noteSection.style.display = 'none';
            }
        }

        // Setup character counter
        function setupCharacterCounter() {
            const textarea = document.getElementById('custom-note');
            const counter = document.getElementById('char-count');
            
            if (textarea && counter) {
                textarea.addEventListener('input', function() {
                    const count = this.value.length;
                    counter.textContent = count;
                    
                    if (count > 180) {
                        counter.style.color = 'var(--color-red-flag)';
                    } else {
                        counter.style.color = 'rgba(247, 243, 237, 0.5)';
                    }
                });
            }
        }

        // Proceed to Stripe checkout
        async function proceedToStripe() {
            const checkoutButton = document.getElementById('checkout-button');
            const checkoutText = document.getElementById('checkout-text');
            const checkoutSpinner = document.getElementById('checkout-spinner');
            const emailInput = document.getElementById('customer-email');
            const customNote = document.getElementById('custom-note');
            const newsletterSignup = document.getElementById('newsletter-signup');

            // Validate email
            if (!emailInput.value || !emailInput.value.includes('@')) {
                alert('Please enter a valid email address.');
                emailInput.focus();
                return;
            }

            // Show loading state
            checkoutButton.disabled = true;
            checkoutText.textContent = 'Processing...';
            checkoutSpinner.style.display = 'inline-block';

            try {
                // Collect order data
                const orderData = {
                    product: currentProduct.id,
                    email: emailInput.value,
                    customNote: customNote ? customNote.value : null,
                    newsletterSignup: newsletterSignup.checked,
                    timestamp: new Date().toISOString()
                };

                // Store order data for admin panel (in a real app, this would go to your database)
                const existingOrders = JSON.parse(localStorage.getItem('pending_orders') || '[]');
                existingOrders.push({
                    id: 'temp_' + Date.now(),
                    ...orderData,
                    status: 'pending_payment'
                });
                localStorage.setItem('pending_orders', JSON.stringify(existingOrders));

                // Handle newsletter signup
                if (newsletterSignup.checked) {
                    await submitToFormspree(emailInput.value);
                }

                // Determine which Stripe URL to use (regular or discounted)
                let stripeUrl;
                const discountCode = localStorage.getItem('discount_code');
                const discountExpiry = localStorage.getItem('discount_expiry');
                
                // Check if discount code is valid and not expired
                const hasValidDiscount = discountCode && 
                                       discountExpiry && 
                                       Date.now() < parseInt(discountExpiry) &&
                                       currentProduct.discountUrl &&
                                       !currentProduct.discountUrl.includes('PLACEHOLDER');
                
                // Debug logging
                console.log('üí≥ Checkout Debug:', {
                    discountCode,
                    discountExpiry,
                    discountValid: discountCode && discountExpiry && Date.now() < parseInt(discountExpiry),
                    hasDiscountUrl: !!currentProduct.discountUrl,
                    discountUrl: currentProduct.discountUrl,
                    regularUrl: currentProduct.stripeUrl,
                    hasValidDiscount,
                    currentProduct: currentProduct.name,
                    timeUntilExpiry: discountExpiry ? Math.round((parseInt(discountExpiry) - Date.now()) / 1000 / 60) + ' minutes' : 'N/A'
                });
                
                if (hasValidDiscount) {
                    stripeUrl = currentProduct.discountUrl;
                    console.log(`üéâ DISCOUNT APPLIED! Using discounted link for ${discountCode}`);
                    console.log(`üîó Discount URL: ${stripeUrl}`);
                    console.log(`üí∞ Price: $${currentProduct.price} ‚Üí $${currentProduct.discountedPrice}`);
                    
                    // Track discount usage
                    if (typeof gtag !== 'undefined') {
                        gtag('event', 'discount_code_used', {
                            event_category: 'Conversion',
                            event_label: discountCode,
                            value: currentProduct.price - currentProduct.discountedPrice
                        });
                    }
                    
                    // Clear discount after use (single-use)
                    localStorage.removeItem('discount_code');
                    localStorage.removeItem('discount_expiry');
                } else {
                    stripeUrl = currentProduct.stripeUrl;
                    console.log('‚ùå NO DISCOUNT - Using regular price link');
                    console.log(`üîó Regular URL: ${stripeUrl}`);
                    console.log(`üí∞ Full Price: $${currentProduct.price}`);
                    
                    if (discountCode && !hasValidDiscount) {
                        console.log('‚ö†Ô∏è Discount code found but not valid:', {
                            code: discountCode,
                            expired: discountExpiry && Date.now() >= parseInt(discountExpiry),
                            noDiscountUrl: !currentProduct.discountUrl,
                            isPlaceholder: currentProduct.discountUrl && currentProduct.discountUrl.includes('PLACEHOLDER')
                        });
                    }
                }
                
                // Legacy discount handling (fallback for manual refunds)
                if (discountCode && !hasValidDiscount) {
                    // Store discount info for manual processing if no discounted link available
                    localStorage.setItem('pending_discount', JSON.stringify({
                        email: emailInput.value,
                        code: discountCode,
                        amount: getDiscountAmount(currentProduct.price),
                        timestamp: Date.now()
                    }));
                    
                    // Add discount note to custom note for manual processing
                    const discountNote = `DISCOUNT CODE: ${discountCode} - 20% refund requested`;
                    if (customNote && customNote.value) {
                        customNote.value += '\n\n' + discountNote;
                    } else if (customNote) {
                        customNote.value = discountNote;
                    }
                }
                
                if (customNote && customNote.value && (currentProduct.type === 'physical' || currentProduct.type === 'bundle')) {
                    // Keep local fallback copy for manual reconciliation
                    localStorage.setItem('custom_note_' + Date.now(), JSON.stringify({
                        email: emailInput.value,
                        note: customNote.value,
                        product: currentProduct.id
                    }));
                }

                // Preferred flow: create Checkout Session server-side so metadata is preserved and available to webhooks
                try {
                    const payload = {
                        product: currentProduct.id,
                        email: emailInput.value,
                        customNote: customNote ? customNote.value : null,
                        newsletterSignup: newsletterSignup.checked,
                        discountCode: discountCode || null
                    };

                    console.log('Posting to /api/create-checkout-session', payload);

                    const resp = await fetch('/api/create-checkout-session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        throw new Error(err.error || 'Failed to create checkout session');
                    }

                    const data = await resp.json();
                    if (data && data.url) {
                        console.log('Redirecting to Stripe session URL:', data.url);
                        window.location.href = data.url;
                        return;
                    } else if (data && data.id) {
                        // Fallback: redirect to success url if session url missing
                        window.location.href = `${window.location.origin}/checkout-success.html?session_id=${encodeURIComponent(data.id)}`;
                        return;
                    } else {
                        throw new Error('No session URL returned');
                    }
                } catch (err) {
                    console.error('Failed to create checkout session, falling back to direct Stripe link:', err);
                    // Final fallback: redirect to raw Stripe link
                    window.location.href = stripeUrl;
                    return;
                }

            } catch (error) {
                console.error('Checkout error:', error);
                alert('There was an error processing your order. Please try again.');
            } finally {
                // Reset button state
                checkoutButton.disabled = false;
                checkoutText.textContent = 'Continue to Secure Payment';
                checkoutSpinner.style.display = 'none';
            }
        }

        // Discount handling functions
        function checkForDiscount() {
            const urlParams = new URLSearchParams(window.location.search);
            const discountParam = urlParams.get('discount');
            
            if (discountParam) {
                localStorage.setItem('discount_code', discountParam);
                localStorage.setItem('discount_expiry', (Date.now() + 24 * 60 * 60 * 1000).toString());
            }
            
            const discountCode = localStorage.getItem('discount_code');
            const discountExpiry = localStorage.getItem('discount_expiry');
            
            if (discountCode && discountExpiry && Date.now() < parseInt(discountExpiry)) {
                showDiscountSection(discountCode);
            }
        }
        
        function showDiscountSection(code) {
            const discountSection = document.getElementById('discount-section');
            const appliedCodeElement = document.getElementById('applied-discount-code');
            const discountAmountElement = document.getElementById('discount-amount');
            
            if (discountSection && appliedCodeElement && discountAmountElement) {
                const currentProduct = getCurrentProduct();
                
                // Only show discount for audiobook
                if (!currentProduct || getCurrentProductId() !== 'audiobook') {
                    discountSection.style.display = 'none';
                    return;
                }
                
                appliedCodeElement.textContent = code;
                
                // Calculate discount amount for audiobook only
                if (currentProduct && currentProduct.discountedPrice) {
                    const discountAmount = currentProduct.price - currentProduct.discountedPrice;
                    discountAmountElement.textContent = `-$${discountAmount.toFixed(2)}`;
                    
                    // Update main price display to show discounted price
                    updatePriceDisplay(currentProduct);
                } else {
                    // Fallback to 20% calculation for audiobook only
                    const discountAmount = getDiscountAmount(7.99); // Fixed audiobook price
                    discountAmountElement.textContent = `-$${discountAmount.toFixed(2)}`;
                }
                
                discountSection.style.display = 'block';
            }
        }
        
        function updatePriceDisplay(product) {
            const priceElement = document.querySelector('#product-price');
            if (priceElement && product.discountedPrice) {
                priceElement.innerHTML = `
                    <span class="line-through text-bone/50">$${product.price.toFixed(2)}</span>
                    <span class="text-green-400 font-bold">$${product.discountedPrice.toFixed(2)}</span>
                `;
            }
        }
        
        function getDiscountAmount(price) {
            return price * 0.20; // 20% discount
        }
        
        function removeDiscount() {
            localStorage.removeItem('discount_code');
            localStorage.removeItem('discount_expiry');
            document.getElementById('discount-section').style.display = 'none';
        }
        
        function getCurrentProduct() {
            return window.currentProduct || products.audiobook; // fallback
        }
        
        function getCurrentProductId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('product') || 'audiobook';
        }

        // Submit email to Formspree for newsletter
        async function submitToFormspree(email) {
            try {
                const response = await fetch('https://formspree.io/f/myzjjjjp', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: email,
                        _subject: 'New Newsletter Subscription from Checkout',
                        source: 'Checkout Page'
                    })
                });
                
                console.log('Newsletter signup submitted');
            } catch (error) {
                console.error('Newsletter signup error:', error);
            }
        }

        // Initialize page when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            checkForDiscount(); // Check for discount codes
        });
    </script>

    <!-- Enhanced Features Scripts -->
    <script src="/js/trust-badges.js"></script>
    
    
    <!-- Cookie Notice JavaScript -->
    <script src="js/cookie-notice.js"></script>


    <!-- Academic Citation Metadata -->
    <meta name="citation_author" content="Aleks Filmore">
    <meta name="citation_title" content="The Worst Boyfriends Ever">
    <meta name="citation_publication_date" content="2025-01-06">
    <meta name="citation_publisher" content="Filmore Creative">
    <meta name="citation_website" content="https://aleksfilmore.com">
</body>
</html>

